worker_processes  auto;
pid /tmp/nginx.pid;
events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    log_format  main  '$remote_addr - $remote_user [$time_local] ""$request"" '
                      '$status $body_bytes_sent ""$http_referer"" '
                      '""$http_user_agent"" ""$http_x_forwarded_for""';

    log_format json '{'
                      '"time":"$time_iso8601",'
                      '"remoteIP":"$remote_addr",'
                      '"port":"$server_port",'
                      '"serverIP":"$server_addr",'
                      '"serverName":"$server_name",'
                      '"httpHost":"$hostname",'
                      '"reqTime":"$request_time",'
                      '"resStatus":"$status",'
                      '"protocol":"$http_x_forwarded_proto",'
                      '"sendBytesWithoutHeader":"$body_bytes_sent",'
                      '"sendBytesWithHeader":"$bytes_sent",'
                      '"fpath":"$request_filename",'
                      '"reqURL":"$request_uri",'
                      '"query":"$query_string",'
                      '"headerLocation":"sent_http_location",'
                      '"method":"$request_method",'
                      '"ua":"$http_user_agent",'
                      '"xForwardedFor":"$http_x_forwarded_for",'
                      '"referer":"$http_referer"'
                      '}';

    sendfile        on;
    server_tokens    off;
    keepalive_timeout  61;

    server {
        listen 8080;

        access_log /dev/stdout json;
        error_log /dev/stderr;

        charset UTF-8;
        client_max_body_size 16m;

        #--------------------
        # GZIP settings
        #--------------------
        gzip              on;
        gzip_disable      "msie6"
        gzip_vary         on;
        gzip_proxied      any;
        gzip_comp_level   5;
        gzip_buffers      16 8k;
        gzip_http_version 1.1;
        gzip_types        text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

        root /var/app/public;

        location / {
          index     index.php index.html index.htm;
          try_files $uri /index.php?$query_string;
        }

        location ~ \.php$ {
          fastcgi_pass localhost:9000;
          fastcgi_index index.php;
          fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
          include       fastcgi_params;
          fastcgi_intercept_errors        on;
          fastcgi_ignore_client_abort     off;
          fastcgi_connect_timeout 60;
          fastcgi_send_timeout 180;
          fastcgi_read_timeout 180;
          fastcgi_buffer_size 128k;
          fastcgi_buffers 4 256k;
          fastcgi_busy_buffers_size 256k;
          fastcgi_temp_file_write_size 256k;
        }

        location /nginx_status {
          if ($http_x_probe_header != "3939") {
            return 403;
          }
          stub_status on;
          access_log off;
        }

        location /phpfpm_status {
          if ($http_x_probe_header != "3939") {
            return 403;
          }
          include fastcgi_params;
          fastcgi_pass localhost:9000;
          fastcgi_param SCRIPT_FILENAME $fastcgi_script_name;
          access_log off;
        }

        location /phpfpm_ping {
          if ($http_x_probe_header != "3939") {
            return 403;
          }
          include fastcgi_params;
          fastcgi_pass localhost:9000;
          fastcgi_param SCRIPT_FILENAME $fastcgi_script_name;
          access_log off;
        }

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        location ~ /\.ht {
            deny  all;
        }

        #--------------------------------------
        # deny .git or .htaccess or .svn files
        #--------------------------------------
        location ~ /\.(ht|git|svn) {
            deny all;
        }

        #--------------------------------------
        # dont save access log for favicon
        #--------------------------------------
        location = /favicon.ico {
            access_log off;
            log_not_found off;
        }

        #--------------------------------------
        # dont save access log for robots.txt
        #--------------------------------------
        location = /robots.txt {
            access_log off;
            log_not_found off;
        }
    }
}

